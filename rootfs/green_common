#!/bin/sh

DATE=`date +'%Y%m%d %T'`

KERNEL_VERSION=`uname -r | sed -e 's/-greenbox//'`
DOCKER_VERSION=`cat /etc/sysconfig/docker`
VBOX_VERSION=5.1.8
VAGRANT_VERSION=1.8.6
GREEN_APPS_VERSION=1.6.1
X11_APPS_VERSION=1.0.0
VIM_VERSION=8.0.5
PERL5_VERSION="5.22.1"
PYTHON2_VERSION="2.7.12"

BOOT_DIR=/opt/boot

set_log_file() {
[ -f /opt/boot/etc/profile ] && source /opt/boot/etc/profile

if [ -d /opt/boot/log ]
then
  LOG_FILE=/var/log/greenbox.log
else
  LOG_FILE=/var/log/greenbox_0.log
fi

export LOG_FILE
}


log_msg() {
  echo "$0 $DATE: $1" >> $LOG_FILE
}

mountedOnGreen() {
  (cat /proc/mounts | grep -q "^green/$1")
}

zfs_up() {
  zfs list | grep -q green
}

is_vbox () {
  lshw | grep -q "product: VirtualBox"
}


wait_zvol_up () {

retry=0
while [ ! -e /dev/zvol/$1/$2 ] &&  [ $retry -lt 12 ]
do
   log_msg "waiting zvol $retry $1 $2 up"
   sleep 1
   let retry=retry+1
done

}

mount_opt() {

if [ -d /opt/apps/$1 ] ; then
  if ! $(grep -q \/opt\/$1 /proc/mounts) ; then
    echo mkdir, mount /opt/apps/$1 ...
    sudo mkdir -p /opt/$1
    sudo mount --bind /opt/apps/$1 /opt/$1 >> $LOG_FILE
    log_msg "/opt/$1 bind mounted"
  fi
fi

}

umount_opt() {

if [ -d /opt/apps/$1 ] ; then
  if  $(grep -q \/opt\/$1 /proc/mounts) ; then
    sudo umount -f -l /opt/$1 >> $LOG_FILE
  fi
fi

}


set_path_ld_library() {

for appdir in `ls -1 /opt`
do
   if [ -d /opt/$appdir/lib ] ; then
      LD_LIBRARY_PATH=/opt/$appdir/lib:$LD_LIBRARY_PATH
   fi

   if [ -d /opt/$appdir/bin ] ; then
      PATH=/opt/$appdir/bin:$PATH
   else
      if  [ -d /opt/$appdir ] && [ "$appdir" != "apps" ] && [ "$appdir" != "boot" ] ; then
         export PATH=/opt/$appdir:$PATH
      fi
   fi
done

}

change_user_password() {
   echo "$1:$2" | chpasswd -m
}

GREEN_DEBUG=${GREEN_DEBUG:-1}
set_log_file
