#!/bin/bash
. /etc/green_common

if [ ! -f /opt/apps/green/bin/coredns ] ; then
  log_msg "no coredns execute" R
  exit 0
fi
if [ ! -f /etc/Corefile ] ; then
  log_msg "no coredns config" R
  exit 0
fi

if ps -ax | grep "coredns.*Corefile" | grep -v grep ; then
   killall coredns
fi

if echo -e > $BOOT_DIR/log/coredns.log ; then
  # $BOOT_DIR/log not writeable
  sed -i -e 's/ log / #log /' /etc/Corefile
  sed -i -e 's/ error / #error /' /etc/Corefile
else
  sed -i -e 's/ #log / log /' /etc/Corefile
  sed -i -e 's/ #error / error /' /etc/Corefile
fi

log_msg "start coredns /etc/Corefile" M
/opt/apps/green/bin/coredns -conf /etc/Corefile &
