#!/bin/bash

# https://github.com/bjasko/docker_scripts/blob/master/greenbox_usb_update

if [ $# -lt 1 ]
then
    echo "argumenti su: ./greenbox_usb_update  [GREENBOX_VER]"
    echo " npr:   ./greenbox_usb_create 3.7.2"
    exit 1
fi

if [ "$(id -u)" != "0" ]; then
    echo "Pokreni kao root" 1>&2
    exit 1
fi

GREENBOX_VERSION=$1
GREEN_ISO=http://download.bring.out.ba/greenbox-${GREENBOX_VERSION}.iso
GREEN_CFG=/media/syslinux.cfg
DEF_BOOT=`cat $GREEN_CFG | grep "^default boot" | awk '{print $2}'`
ISO_MNT=/tmp/${GREENBOX_VERSION}
BOOT_PATH=/media/boot

if wget --spider $GREEN_ISO 2>/dev/null; then
    echo "update postoji, nastavljam"
    cd  /tmp && wget -q $GREEN_ISO
else
    echo "update iso ne postoji"
    exit
fi

echo "default boot is $DEF_BOOT"

if [ -d "$ISO_MNT" ]; then
    echo "ISO mountpoint $ISO_MNT postoji, provjerite, prekidam..... "
    exit
else
    mkdir $ISO_MNT
    mount -o loop /tmp/greenbox-${GREENBOX_VERSION}.iso  $ISO_MNT
fi

if [ -d "$BOOT_PATH/${GREENBOX_VERSION}" ]; then
    echo "$BOOT_PATH/${GREENBOX_VERSION} veÄ‡ postoji, provjerite......"
    exit
else
    mkdir $BOOT_PATH/${GREENBOX_VERSION}
    cp $ISO_MNT/boot/initrd.img  $BOOT_PATH/${GREENBOX_VERSION}
    cp $ISO_MNT/boot/vmlinuz64 $BOOT_PATH/${GREENBOX_VERSION}
    umount $ISO_MNT
    rm -rf $ISO_MNT
fi

if [ "$DEF_BOOT" == "boot${GREENBOX_VERSION}" ]; then
    echo "$DEF_BOOT je default boot ... STOP"
    exit 1
else
    echo "label boot${GREENBOX_VERSION}" >> $GREEN_CFG
    echo "menu label greenbox-${GREENBOX_VERSION}" >> $GREEN_CFG
    echo "kernel /boot/${GREENBOX_VERSION}/vmlinuz64"  >> $GREEN_CFG
    echo "append initrd=/boot/${GREENBOX_VERSION}/initrd.img loglevel=3 dockerpwd=test01 tz=CET-1CEST,M3.5.0,M10.5.0/3 noembed nomodeset norestore waitusb=10 LABEL=GREEN_HDD console=ttyS0,115200n8"  >> $GREEN_CFG
    echo ""  >> $GREEN_CFG
fi


sed -i -e 's/default '"$DEF_BOOT"'/default boot'"${GREENBOX_VERSION}"'/' $GREEN_CFG
sync
echo "default boot is: ${GREENBOX_VERSION}"
